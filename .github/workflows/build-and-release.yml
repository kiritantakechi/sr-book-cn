name: Build and Release PDF

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  pull-requests: read

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Typst
      uses: typst-community/setup-typst@v3
      with:
        typst-version: latest
        
    - name: Install fonts
      run: |
        # Create fonts directory for system fonts
        sudo mkdir -p /usr/share/fonts/truetype/custom
        
        # Copy project fonts to system fonts directory
        sudo cp fonts/*.ttf /usr/share/fonts/truetype/custom/ || true
        
        # Copy Times New Roman fonts if they exist
        if [ -d "fonts/TimesNewRoman" ]; then
          sudo cp fonts/TimesNewRoman/*.ttf /usr/share/fonts/truetype/custom/ || true
        fi
        
        # Update font cache
        sudo fc-cache -fv
        
        # List available fonts for debugging
        fc-list | grep -i "times\|simsun\|simhei\|kaiti\|fangsong" || echo "Custom fonts may not be loaded"
        
    - name: Build PDF
      run: |
        # Build the book PDF from template with project root
        typst compile --root . template/book.typ book.pdf

        # Verify PDF was created
        if [ ! -f "book.pdf" ]; then
          echo "Error: PDF was not generated"
          exit 1
        fi

        # Show PDF info
        ls -la book.pdf
        
    - name: Upload PDF as artifact
      uses: actions/upload-artifact@v4
      with:
        name: sr-book-cn-pdf
        path: book.pdf
        retention-days: 30
        
    - name: Get commit info
      id: commit
      run: |
        echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "commit_message=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT
        echo "commit_date=$(git log -1 --pretty=%cd --date=short)" >> $GITHUB_OUTPUT
        
    - name: Create Release
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ steps.commit.outputs.sha_short }}
        name: "Build ${{ steps.commit.outputs.sha_short }} - ${{ steps.commit.outputs.commit_date }}"
        body: |
          ## Automated Build

          **Commit Message**: ${{ steps.commit.outputs.commit_message }}
          **Commit Hash**: ${{ steps.commit.outputs.sha_short }}
          **Build Date**: ${{ steps.commit.outputs.commit_date }}

          This is an automatically built PDF version based on commit ${{ steps.commit.outputs.sha_short }}.

        files: |
          book.pdf
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Clean up old releases
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: dev-drprasad/delete-older-releases@v0.3.4
      with:
        keep_latest: 5
        delete_tag_pattern: "^(latest-|build-)"
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Delete all existing Latest releases
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        echo "ðŸ—‘ï¸ Deleting all existing 'Latest' releases..."
        # Use GitHub CLI to find and delete releases with "Latest" in title
        gh release list --limit 50 --json tagName,name | jq -r '.[] | select(.name | contains("Latest")) | .tagName' | while read tag; do
          if [ -n "$tag" ]; then
            echo "Deleting latest release: $tag"
            gh release delete "$tag" --yes --cleanup-tag 2>/dev/null || true
          fi
        done

        # Wait for deletions to complete
        sleep 3
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create new Latest release
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        # Create new timestamped release and mark it as the only latest
        RELEASE_TAG="latest-$(date +%Y%m%d-%H%M%S)"
        echo "ðŸ“¦ Creating new latest release: $RELEASE_TAG"

        gh release create "$RELEASE_TAG" book.pdf \
          --title "Symphonic Rain Chinese Translation - Latest (${{ steps.commit.outputs.commit_date }})" \
          --notes "ðŸŽ¯ **This is the LATEST version** - Always download this one for the most recent translation.

        **Latest Commit**: ${{ steps.commit.outputs.commit_message }}
        **Commit Hash**: ${{ steps.commit.outputs.sha_short }}
        **Build Date**: ${{ steps.commit.outputs.commit_date }}

        ðŸ“¥ Download \`book.pdf\` to get the latest version of the Chinese translation.

        ---
        *This release is automatically updated with each new commit.*" \
          --latest

        echo "âœ… Latest release created successfully!"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
