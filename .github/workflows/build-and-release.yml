name: Build and Release PDF

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  pull-requests: read

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Typst
      uses: typst-community/setup-typst@v3
      with:
        typst-version: latest
        
    - name: Install fonts
      run: |
        # Create fonts directory for system fonts
        sudo mkdir -p /usr/share/fonts/truetype/custom
        
        # Copy project fonts to system fonts directory
        sudo cp fonts/*.ttf /usr/share/fonts/truetype/custom/ || true
        
        # Copy Times New Roman fonts if they exist
        if [ -d "fonts/TimesNewRoman" ]; then
          sudo cp fonts/TimesNewRoman/*.ttf /usr/share/fonts/truetype/custom/ || true
        fi
        
        # Update font cache
        sudo fc-cache -fv
        
        # List available fonts for debugging
        fc-list | grep -i "times\|simsun\|simhei\|kaiti\|fangsong" || echo "Custom fonts may not be loaded"
        
    - name: Build PDF
      run: |
        # Build the book PDF from template with project root
        typst compile --root . template/book.typ book.pdf

        # Verify PDF was created
        if [ ! -f "book.pdf" ]; then
          echo "Error: PDF was not generated"
          exit 1
        fi

        # Show PDF info
        ls -la book.pdf
        
    - name: Upload PDF as artifact
      uses: actions/upload-artifact@v4
      with:
        name: sr-book-cn-pdf
        path: book.pdf
        retention-days: 30
        
    - name: Get commit info
      id: commit
      run: |
        echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "commit_message=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT
        echo "commit_date=$(git log -1 --pretty=%cd --date=short)" >> $GITHUB_OUTPUT
        
    - name: Create Release
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ steps.commit.outputs.sha_short }}
        name: "Build ${{ steps.commit.outputs.sha_short }} - ${{ steps.commit.outputs.commit_date }}"
        body: |
          ## Automated Build

          **Commit Message**: ${{ steps.commit.outputs.commit_message }}
          **Commit Hash**: ${{ steps.commit.outputs.sha_short }}
          **Build Date**: ${{ steps.commit.outputs.commit_date }}

          This is an automatically built PDF version based on commit ${{ steps.commit.outputs.sha_short }}.

        files: |
          book.pdf
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update latest release
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        # Use a timestamp-based approach to avoid tag conflicts
        RELEASE_TAG="latest-$(date +%Y%m%d-%H%M%S)"

        # First, remove the "latest" flag from all existing releases
        echo "ðŸ·ï¸ Removing 'latest' flag from all existing releases..."
        gh release list --limit 50 | while read line; do
          tag=$(echo "$line" | awk '{print $3}')
          if [ "$tag" != "Draft" ] && [ "$tag" != "" ]; then
            echo "Updating release: $tag"
            gh release edit "$tag" --latest=false 2>/dev/null || true
          fi
        done

        # Clean up old timestamped releases (keep only the most recent 5)
        echo "ðŸ§¹ Cleaning up old timestamped releases..."
        gh release list --limit 50 | grep "latest-" | tail -n +6 | while read line; do
          tag=$(echo "$line" | awk '{print $3}')
          echo "Deleting old release: $tag"
          gh release delete "$tag" --yes 2>/dev/null || true
        done

        # Create new timestamped release and mark it as the only latest
        echo "ðŸ“¦ Creating new latest release: $RELEASE_TAG"
        gh release create "$RELEASE_TAG" book.pdf \
          --title "Symphonic Rain Chinese Translation - Latest (${{ steps.commit.outputs.commit_date }})" \
          --notes "ðŸŽ¯ **This is the LATEST version** - Always download this one for the most recent translation.

        **Latest Commit**: ${{ steps.commit.outputs.commit_message }}
        **Commit Hash**: ${{ steps.commit.outputs.sha_short }}
        **Build Date**: ${{ steps.commit.outputs.commit_date }}

        ðŸ“¥ Download \`book.pdf\` to get the latest version of the Chinese translation.

        ---
        *This release is automatically updated with each new commit.*" \
          --latest

        echo "âœ… Latest release created successfully!"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
